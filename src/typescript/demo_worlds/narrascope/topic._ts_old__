import { gist, GistRenderer, gists_equal } from 'gist';
import { StaticMap } from '../../lib/static_resources';
import { cond, map, update } from '../../lib/utils';
import { ConsumeSpec } from '../../parser';
import { Puffer } from '../../puffer';
import { StoryUpdaterSpec, story_updater } from '../../story';
import { Puffers, resource_registry, STATIC_TOPIC_IDS, TopicID, Venience } from "./prelude";

export interface Topics {
    has_considered: Map<TopicID, boolean>;
}

export type TopicSpec = {
    name: TopicID,
    cmd: ConsumeSpec,
    can_consider: (w: Venience) => boolean,
    message: (w: Venience) => StoryUpdaterSpec,
    consider?: (w: Venience) => Venience,
    reconsider?: (w2: Venience, w1: Venience) => boolean
}

declare module './prelude' {
    export interface Venience extends Topics {}

    export interface StaticResources {
        initial_world_topic: Topics;
        topic_index: StaticMap<Record<TopicID, TopicSpec>>;
    }
}

resource_registry.initialize('initial_world_topic', {
    has_considered: map()
});

type TopicGists = { [K in TopicID]: {} };

declare module 'gist' {
    export interface StaticGistTypes extends TopicGists {
        'impression': { children: { subject: TopicID } };
    }
}

GistRenderer('impression', {
    noun_phrase: {
        order: 'BottomUp',
        impl: (tag, {subject}) => `your impression of ${subject}`
    },
    command_noun_phrase: {
        order: 'BottomUp',
        impl: (tag, {subject}) => ['my_impression of', subject]
    }
});

export function make_topic(spec: TopicSpec): Puffer<Venience> {
    return {
        handle_command: (world, parser) => {
            if (!spec.can_consider(world)) {
                return parser.eliminate();
            }

            return parser.consume({
                tokens: ['consider', spec.cmd],
                used: world.has_considered.get(spec.name)
            }, () =>
                parser.submit(
                    () => update(world,
                        {
                            story_updates: story_updater(spec.message(world)),
                            gist: () => gist({ tag: 'impression', children: { subject: spec.name} }),
                            has_considered: map( [spec.name, true] )
                        },
                        ...cond(!!spec.consider, () => spec.consider!)
                    )));
        },
        post: (world2, world1) => {
            if (spec.reconsider === undefined ||
                world2.gist && gists_equal(world2.gist, gist('impression', { subject: gist(spec.name) }) ) ||
                !spec.reconsider(world2, world1)) {
                return world2;
            }

            return update(world2, {
                has_considered: map( [spec.name, false] )
            })
        }
    }
}

const topic_index = resource_registry.initialize('topic_index',
    new StaticMap(STATIC_TOPIC_IDS, [
        function add_topic_to_puffers(spec) {
            Puffers(make_topic(spec));
            return spec;
        },
        function add_topic_to_gists(spec) {
            GistRenderer(spec.name, {
                noun_phrase: {
                    order: 'TopDown',
                    impl: () => spec.name
                },
                command_noun_phrase: {
                    order: 'TopDown',
                    impl: () => spec.cmd
                }
            });
            return spec;
        }
    ])
);

export const Topics = (spec: TopicSpec) => topic_index.initialize(spec.name, spec);