import { narrative_fsa_builder } from '../../narrative_fsa';
import { make_puffer_world_spec, PufferAndWorld } from '../../puffer';
import { update } from '../../utils';
import { get_initial_world, World, world_driver } from '../../world';
import { Abstractions, Facets, init_metaphors, init_metaphor_puffers } from './metaphors';
import { global_lock, ObserverMomentID, Owner, PufferIndex, Puffers, Venience } from './prelude';

/*
    TODO
        - Convert various expositive bits to "consider" or "remember" commands, so they can be repeated.
        - use separate state machines for the various flowy bits
            - e.g. first waking up, you awaken, sit up, try to remember, numbers,
            lie down, etc.
        - fix up the parser dsl to support arb token labels
*/

export const null_lock = global_lock()(null);


type PW = PufferAndWorld<Venience>;

let transition_to = (w: PW, node: ObserverMomentID) => update(w, { node });

let {
    make_transitioner,
    make_state,
    apply_state,
    apply_states
} = narrative_fsa_builder<Venience, ObserverMomentID>(w => w.node, transition_to);

let ObserverMoments = (owner: Owner | null = null) =>
    apply_states()(p => { Puffers(global_lock()(owner).make_lockable(p)) });

type AlcoveInterp = {
    dread: boolean,
    ice: boolean,
    horizon: boolean
}

const initial_alcove_interp: AlcoveInterp = {
    dread: false,
    ice: false,
    horizon: false
}

declare module './prelude' {
    export interface Venience {
        alcove_interp: AlcoveInterp;
        // has_perceived: Partial<Record<PerceptID, boolean>>;
    }
}

init_metaphor_puffers();

const alcove_facets_true = {
    "the missing notes": true,
    "the sense of dread": true,
    "your location": true
};

Abstractions({
    name: 'the mountain',
    name_cmd: 'the_mountain', // TODO: need a way to conpose ConsumeSpecs s.t. they appear together as typeahead
    description: "Katya's reflection on sliding down an icy mountain.",
    slug: 'mountain',
    get_cmd: (action) => ['invoking_the_mountain,', action],
    actions: [
    {
        name: 'gravity' as const,
        description: 'A self-centering technique using the everpresence of gravity.',
        slug: 'gravity',
        get_cmd: (facet) => ['judge the_direction_of_gravity_for', facet],
        get_wrong_msg: (facet) => `You struggle to connect the direction of gravity to ${facet}.`
    },
    {
        name: 'ice' as const,
        description: "An appeal to specify the parameters of one's struggle. Even slick ice is not perfectly frictionless.",
        slug: 'ice',
        get_cmd: (facet) => ['judge the_slickness_of_the_ice_for', facet],
        get_wrong_msg: (facet) => `You struggle to connect the slickness of the ice to ${facet}.`
    },
    {
        name: 'horizon' as const,
        description: "A technique to contextualize one's plight by looking beyond it, surveying the horizon.",
        slug: 'horizon',
        get_cmd: (facet) => ['survey the_horizon_from_atop', facet],
        get_wrong_msg: (facet) => `You struggle to connect the horizon to ${facet}.`
    }]
});

Facets({
    name: 'the sense of dread',
    description: `The sense of nervous dread weighing down your mind.`,

    slug: 'dread',
    phrase: 'the_sense_of_dread',
    can_recognize: (current_world, interp_world) =>
        interp_world.node === 'alcove, beginning interpretation' &&
        interp_world.previous!.node !== 'alcove, beginning interpretation',

    correct: ([abs, action], world) => action === 'gravity',

    solved: (world) => world.alcove_interp.dread,

    set_solved: (world) => update(world, {
        alcove_interp: { dread: true },
        has_tried: { gravity: alcove_facets_true }
    }),
},
{
    name: 'the missing notes',
    description: `The disappearance of your notes.`,

    slug: 'missing',
    phrase: 'the_missing_notes',
    can_recognize: (current_world, interp_world) =>
        interp_world.node === 'alcove, beginning interpretation' &&
        interp_world.previous!.node !== 'alcove, beginning interpretation',

    correct: ([abs, action], world) => action === 'ice',

    solved: (world) => world.alcove_interp.ice,

    set_solved: (world) => update(world, {
        alcove_interp: { ice: true },
        has_tried: { ice: alcove_facets_true }}),
},
{
    name: 'your location',
    description: `Your location within the woods; your alcove.`,

    slug: 'lost',
    phrase: 'my_location',
    can_recognize: (current_world, interp_world) =>
        interp_world.node === 'alcove, beginning interpretation' &&
        interp_world.previous!.node !== 'alcove, beginning interpretation',

    correct: ([abs, action], world) => action === 'horizon',

    solved: (world) => world.alcove_interp.horizon,

    set_solved: (world) => update(world, {
        alcove_interp: { horizon: true },
        has_tried: { horizon: alcove_facets_true }}),
},);


ObserverMoments()(
{
    id: 'start',
    transitions: {
        "learning the mountain": 'learn the_mountain'
    }
},
{
    id: 'learning the mountain',
    enter: world => update(world, {
        has_acquired: { "the mountain": true },
        gist: {
            cmd: 'what_I_learned',
            name: 'what you learned'
        }
    }),
    enter_message: `<div class="interp">
    <i>"Catch your breath, dear,"</i> Katya would say. <i>"The mountain, the ice, they are here to tell you something."</i>
    </div>
    <div class="interp">
    <i>"That you are capable of a great deal of care, my dear.
    <br /><br />
    That your capacity to experience meaning is as energetic as a body sliding down a mountain."</i>
    </div>
    <div class="interp"><i>
    "Judge the direction of gravity. Judge the slickness of the ice.
    <br /><br />
    Survey the horizon.
    <br /><br />
    And then, choose where to go."
    </i></div>`,
    transitions: {
        "alcove, beginning interpretation": 'think_about_what_is_going_on'
    },
});

ObserverMoments()(
{
    id: 'alcove, beginning interpretation',
    enter: world => update(world, { gist: { cmd: 'my_predicament', name: 'your predicament' }}),
    enter_message: `
    <div class="dread">
        A nervous energy buzzes within your mind.
        {{#interp-dread}}
            <div class="interp-dread">
                Care. Orientation. Like gravity binds a body to the earth, your vulnerability binds you to a sense of meaning within the world. You have a <i>compass</i>.
            </div>
        {{/interp-dread}}
    </div>
    <div class="missing">
        Your notes are gone.
        {{#interp-missing}}
            <div class="interp-missing">
                Your effort to organize and understand everything Katya taught you over the years. If your notes are truly gone, it is a great setback.
                <br/>
                But the ice is not impossibly slick; the rock face not impossibly sheer. You have your mind. She still whispers to you, even now, <i>my dear.</i>
                <br/>
            </div>
        {{/interp-missing}}
    </div>
    <div class="lost">
        You are alone in a grassy alcove in the forest.
        {{#interp-lost}}
            <div class="interp-lost">
                Indeed. And perhaps it is time to leave. To venture forth from the confines of this sanctuary you have constructed.
                <br/>
                Your view of the horizon is occluded by the trees from in here. Set out, seeking <i>new vantages.</i>
            </div>
        {{/interp-lost}}
    </div>`,
    
},
{
    id: 'alcove, ending interpretation',
    enter_message: `A sense of purpose exists within you. It had been occluded by the panic, but you can feel it there, now.
    <br /><br />
    You do not know precisely what awaits you, out there. You have slept and worked within this alcove for such a long time. You are afraid to leave.
    <br /><br />
    But your sense of purpose compels you. To go. To seek. To try to understand.`,
    transitions: {
        'alcove, entering the forest': 'enter the forest',
    },
    interpretations: {
        'alcove, beginning interpretation': { 'interpretation-active': false }
    }
},
{
    id: 'alcove, entering the forest',
    enter_message: `What lies within the forest, and beyond? What will it be like, out there?`,
    transitions: {'title': 'continue'}
},
{
    id: 'title',
    enter_message: `VENIENCE WORLD
    <br />
    <br />
    An Interactive Fiction by Daniel Spitz`,
    transitions: {'alone in the woods': 'continue'}
}
)

// type PerceptID =
//     'alcove, general' |
//     'self, 1' |
//     'alcove, envelope' |
//     'sequence, 12';

// type Percept = {
//     id: PerceptID,
//     prereqs?: readonly PerceptID[],
//     message: MessageUpdateSpec
// };

// function percieve(world: PW, perc: PerceptID) {
//     return update(world, {
//         has_perceived: { [perc]: true },
//         ...message_updater(Percepts.find(p => p.id === perc)!.message)
//     });
// }

// type PerceptSpec = Partial<Record<PerceptID, ConsumeSpec>>;

// // TODO: Have this take a proper spec as input, like make_transitioner
// function make_perceiver(world: PW, percs: PerceptSpec, prepend_look: boolean=true) {
//     return (parser: Parser) =>
//         parser.split(
//             entries(percs).map(([pid, cmd]) => () => {
//                 let perc = Percepts.find(p => p.id === pid)!;
//                 if (perc.prereqs !== undefined && perc.prereqs.some(p => !world.has_perceived[p])) {
//                     parser.eliminate();
//                 }
//                 let cs: ConsumeSpec[] = [
//                     ...cond(prepend_look, () => ({tokens: 'look', labels: {keyword: true}})),
//                     cmd
//                 ];
//                 parser.consume({tokens: cs, used: world.has_perceived[pid]});
//                 parser.submit();
//                 return percieve(world, pid);
//             })
//         );
// }

// const Percepts: Percept[] = [
//     // {
//     //     id: 'alcove, general',
//     //     message: `
//     //     You turn and dangle your knees off the bed. Your feet brush against the damp grass on the ground.
//     //     <br /><br />
//     //     You see your desk and chair a few paces away, in the center of the alcove.
//     //     <br /><br />
//     //     On all sides you are surrounded by trees.`
//     // },
//     // {
//     //     id: 'self, 1',
//     //     message: `
//     //     You are wearing a perfectly dignified pair of silk pajamas.`
//     // },
//     // {
//     //     id: 'alcove, envelope',
//     //     message: `
//     //     You keep your research in this thick envelope.
//     //     <br/><br/>
//     //     You've been analyzing Katya's work for years now.
//     //     <br/><br/>
//     //     Your career is built in reverence of hers.`
//     // },
//     // {
//     //     id: 'sequence, 12',
//     //     message: `
//     //     The twelfth sequence was the first purely numeric one in Katya's notes.
//     //     <br/><br/>
//     //     None of the greek symbols, none of the allusions to physical constants.
//     //     <br/><br/>
//     //     Just numbers. Eighty-seven of them.`,
//     // },
// ];

interface VenienceWorld extends World, Venience {}

const initial_venience_world: VenienceWorld = {
    ...get_initial_world<VenienceWorld>(),
    node: 'start', //'grass, asking 2', //'bed, sleeping 1',
    // has_perceived: {},
    alcove_interp: initial_alcove_interp,
    ...init_metaphors,
    owner: null    
};

const venience_world_spec = make_puffer_world_spec(initial_venience_world, PufferIndex);

export function new_venience_world() {
    return world_driver(venience_world_spec);
}


